# êµ¬ë§¤ ëª¨ë¸ ê²°ì • - êµ¬ë… vs 1íšŒì„±

## ğŸ“Š ë¹„êµ ë¶„ì„

### Option 1: êµ¬ë… ëª¨ë¸ (Subscription)

**ì¥ì **:
- âœ… **ì•ˆì •ì ì¸ ë°˜ë³µ ìˆ˜ìµ** (MRR)
- âœ… ì‚¬ìš©ì ì´íƒˆ ì¶”ì  ìš©ì´
- âœ… ì§€ì†ì ì¸ ê³ ê° ê´€ê³„
- âœ… ë‚®ì€ ì´ˆê¸° ì§„ì… ì¥ë²½

**ë‹¨ì **:
- âŒ ì‚¬ìš©ì ë¶€ë‹´ (ë§¤ë‹¬ ê²°ì œ)
- âŒ êµ¬ë… í”¼ë¡œë„
- âŒ ì·¨ì†Œ/í™˜ë¶ˆ ê´€ë¦¬ í•„ìš”

**ê°€ê²© ì˜ˆì‹œ**:
- â‚©4,900/ì›”
- â‚©49,000/ë…„ (ì›” â‚©4,083, 17% í• ì¸)

**ìˆ˜ìµ ì˜ˆì¸¡** (ì‚¬ìš©ì 1,000ëª… ê¸°ì¤€):
```
ì›”ê°„ êµ¬ë…ì 100ëª… Ã— â‚©4,900 = â‚©490,000/ì›”
ì—°ê°„ êµ¬ë…ì 50ëª… Ã— â‚©49,000 = â‚©2,450,000 (1íšŒ)
                            = â‚©204,166/ì›” í‰ê· 

â†’ ì›” ì˜ˆìƒ ìˆ˜ìµ: â‚©694,166
â†’ ì—° ì˜ˆìƒ ìˆ˜ìµ: â‚©8,329,992
```

---

### Option 2: 1íšŒì„± êµ¬ë§¤ (One-time Purchase)

**ì¥ì **:
- âœ… **ë†’ì€ ì‹¬ë¦¬ì  ê°€ì¹˜** (í‰ìƒ ì†Œìœ )
- âœ… ì‚¬ìš©ì ë¶€ë‹´ ë‚®ìŒ (1ë²ˆë§Œ ê²°ì œ)
- âœ… êµ¬ë… ê´€ë¦¬ ë¶ˆí•„ìš”
- âœ… í™˜ë¶ˆ ê´€ë¦¬ ë‹¨ìˆœ

**ë‹¨ì **:
- âŒ ë°˜ë³µ ìˆ˜ìµ ì—†ìŒ
- âŒ ë†’ì€ ì´ˆê¸° ê°€ê²© ì¥ë²½
- âŒ ì´íƒˆ ì¶”ì  ì–´ë ¤ì›€

**ê°€ê²© ì˜ˆì‹œ**:
- â‚©49,000 (í‰ìƒ)

**ìˆ˜ìµ ì˜ˆì¸¡** (ì‚¬ìš©ì 1,000ëª… ê¸°ì¤€):
```
êµ¬ë§¤ì 150ëª… Ã— â‚©49,000 = â‚©7,350,000 (1íšŒ)
â†’ ì´í›„ ì‹ ê·œ ìœ ì…ë§Œ ì˜ì¡´

í‰ê·  ì›” ì‹ ê·œ 50ëª… Ã— 15% ì „í™˜ Ã— â‚©49,000 = â‚©367,500/ì›”
â†’ ì—° ì˜ˆìƒ ìˆ˜ìµ: â‚©4,410,000 (2ë…„ì°¨ ì´í›„)
```

---

### Option 3: **í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸** (ì¶”ì²œ! â­)

**ì „ëµ**: ì‚¬ìš©ì ì„ íƒê¶Œ ì œê³µ

```
1. ì›”ê°„ êµ¬ë…:    â‚©4,900/ì›”  (ë¶€ë‹´ ë‚®ìŒ)
2. ì—°ê°„ êµ¬ë…:    â‚©49,000/ë…„ (17% í• ì¸)
3. í‰ìƒ êµ¬ë§¤:    â‚©99,000    (í‰ìƒ ì†Œìœ )
```

**ì¥ì **:
- âœ… **ìµœëŒ€ ì „í™˜ìœ¨** (ê°€ê²©ëŒ€ë³„ ì„ íƒ)
- âœ… ë‹¤ì–‘í•œ ìˆ˜ìµì›
- âœ… ì‚¬ìš©ì ë§Œì¡±ë„ â†‘
- âœ… í”„ë¦¬ë¯¸ì—„ ëŠë‚Œ

**ìˆ˜ìµ ì˜ˆì¸¡** (ì‚¬ìš©ì 1,000ëª… ê¸°ì¤€):
```
ì›”ê°„ êµ¬ë…:  60ëª… Ã— â‚©4,900 = â‚©294,000/ì›”
ì—°ê°„ êµ¬ë…:  30ëª… Ã— â‚©49,000 = â‚©1,470,000 (ì—° 1íšŒ)
í‰ìƒ êµ¬ë§¤:  30ëª… Ã— â‚©99,000 = â‚©2,970,000 (1íšŒ)

â†’ 1ë…„ì°¨ ìˆ˜ìµ: â‚©294,000Ã—12 + â‚©1,470,000 + â‚©2,970,000
            = â‚©7,968,000

â†’ 2ë…„ì°¨+ ìˆ˜ìµ: â‚©294,000Ã—12 + â‚©1,470,000 + ì‹ ê·œ ìœ ì…
             = â‚©5,058,000 + Î±
```

---

## ğŸ¯ ê¶Œì¥ ëª¨ë¸: í•˜ì´ë¸Œë¦¬ë“œ

### ì´ìœ 

1. **ì‚¬ìš©ì ì„ íƒê¶Œ**
   - í•™ìƒ/ì €ì†Œë“: ì›” â‚©4,900
   - í™•ì‹ ìˆëŠ” ì‚¬ìš©ì: í‰ìƒ â‚©99,000

2. **ê°€ê²© ì‹¬ë¦¬í•™**
   - ì›” â‚©4,900 = ì»¤í”¼ 1ì” (ì €ë ´í•¨)
   - í‰ìƒ â‚©99,000 = ì²´ìœ¡ê´€ 3ê°œì›” (ê°€ì¹˜ìˆìŒ)

3. **ìˆ˜ìµ ë‹¤ê°í™”**
   - ë°˜ë³µ ìˆ˜ìµ (êµ¬ë…)
   - ëŒ€í˜• ìˆ˜ìµ (í‰ìƒ)

---

## ğŸ’³ ìƒí’ˆ êµ¬ì„±

### Google Play ìƒí’ˆ ID

```dart
// lib/services/billing_service.dart

static const Set<String> _subscriptionIds = {
  'premium_monthly',   // â‚©4,900/ì›”
  'premium_yearly',    // â‚©49,000/ë…„
};

static const Set<String> _inAppPurchaseIds = {
  'premium_lifetime',  // â‚©99,000 (1íšŒ)
};
```

### UserSubscription íƒ€ì… í™•ì¥

```dart
// lib/models/user_subscription.dart

enum SubscriptionType {
  free,           // ë¬´ë£Œ (Week 1-2)
  launchPromo,    // ëŸ°ì¹­ í”„ë¡œëª¨ (1ê°œì›” ë¬´ë£Œ)
  monthly,        // ì›”ê°„ êµ¬ë… (â‚©4,900/ì›”)
  yearly,         // ì—°ê°„ êµ¬ë… (â‚©49,000/ë…„)
  lifetime,       // í‰ìƒ êµ¬ë§¤ (â‚©99,000, ë§Œë£Œ ì—†ìŒ)
}
```

---

## ğŸ¨ UI í‘œí˜„

### Paywall í™”ë©´ (Week 2 ì™„ë£Œ í›„)

```dart
showDialog(
  context: context,
  builder: (context) => PremiumPlansDialog(
    plans: [
      PremiumPlan(
        type: 'monthly',
        price: 'â‚©4,900',
        period: 'ì›”',
        badge: 'ë¶€ë‹´ ì—†ì´',
        features: ['Week 3-14 ì ‘ê·¼', 'í´ë¼ìš°ë“œ ë™ê¸°í™”'],
      ),
      PremiumPlan(
        type: 'yearly',
        price: 'â‚©49,000',
        period: 'ë…„',
        badge: '17% í• ì¸',
        savings: 'â‚©9,800 ì ˆì•½',
        features: ['Week 3-14 ì ‘ê·¼', 'í´ë¼ìš°ë“œ ë™ê¸°í™”'],
      ),
      PremiumPlan(
        type: 'lifetime',
        price: 'â‚©99,000',
        period: 'í‰ìƒ',
        badge: 'ì¸ê¸° ğŸ”¥',
        savings: 'êµ¬ë…ë³´ë‹¤ 2ë…„ í›„ ì´ë“',
        features: [
          'Week 3-14 í‰ìƒ ì ‘ê·¼',
          'í´ë¼ìš°ë“œ ë™ê¸°í™”',
          'í–¥í›„ ì—…ë°ì´íŠ¸ ë¬´ë£Œ',
          'í”„ë¦¬ë¯¸ì—„ ë°°ì§€',
        ],
        highlighted: true, // ì¶”ì²œ ê°•ì¡°
      ),
    ],
  ),
);
```

---

## ğŸ”„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### êµ¬ë… vs í‰ìƒ êµ¬ë§¤ ì²˜ë¦¬

```dart
// lib/services/billing_service.dart

Future<void> _activateSubscription(String productId) async {
  final auth = FirebaseAuth.instance;
  final userId = auth.currentUser?.uid;

  if (userId == null) {
    // íšŒì›ê°€ì… ìœ ë„
    _onAccountRequired?.call();
    return;
  }

  final cloudSyncService = CloudSyncService();

  // ìƒí’ˆ íƒ€ì… í™•ì¸
  UserSubscription subscription;

  if (productId == 'premium_monthly') {
    subscription = UserSubscription.createMonthlySubscription(userId);
  } else if (productId == 'premium_yearly') {
    subscription = UserSubscription.createYearlySubscription(userId);
  } else if (productId == 'premium_lifetime') {
    subscription = UserSubscription.createLifetimeSubscription(userId);
  } else {
    throw Exception('Unknown product ID: $productId');
  }

  // Firestoreì— ì €ì¥
  await cloudSyncService.saveSubscription(subscription);

  debugPrint('âœ… êµ¬ë… í™œì„±í™”: ${subscription.type}');
}
```

### UserSubscription ìƒì„±ì ì¶”ê°€

```dart
// lib/models/user_subscription.dart

// ì›”ê°„ êµ¬ë…
static UserSubscription createMonthlySubscription(String userId) {
  final now = DateTime.now();
  final endDate = now.add(const Duration(days: 30));

  return UserSubscription(
    id: 'monthly_${userId}_${now.millisecondsSinceEpoch}',
    userId: userId,
    type: SubscriptionType.monthly,
    status: SubscriptionStatus.active,
    startDate: now,
    endDate: endDate,
    hasAds: false,
    allowedWeeks: 14,
    allowedFeatures: [...], // ëª¨ë“  ê¸°ëŠ¥
    createdAt: now,
    updatedAt: now,
  );
}

// ì—°ê°„ êµ¬ë…
static UserSubscription createYearlySubscription(String userId) {
  final now = DateTime.now();
  final endDate = now.add(const Duration(days: 365));

  return UserSubscription(
    id: 'yearly_${userId}_${now.millisecondsSinceEpoch}',
    userId: userId,
    type: SubscriptionType.yearly,
    status: SubscriptionStatus.active,
    startDate: now,
    endDate: endDate,
    hasAds: false,
    allowedWeeks: 14,
    allowedFeatures: [...],
    createdAt: now,
    updatedAt: now,
  );
}

// í‰ìƒ êµ¬ë§¤
static UserSubscription createLifetimeSubscription(String userId) {
  final now = DateTime.now();

  return UserSubscription(
    id: 'lifetime_${userId}_${now.millisecondsSinceEpoch}',
    userId: userId,
    type: SubscriptionType.lifetime,
    status: SubscriptionStatus.active,
    startDate: now,
    endDate: null, // ë§Œë£Œ ì—†ìŒ!
    hasAds: false,
    allowedWeeks: 14,
    allowedFeatures: [
      'full_workouts',
      'cloud_sync',
      'advanced_stats',
      'achievement_system',
      'premium_badge',      // ì¶”ê°€!
      'future_updates',     // ì¶”ê°€!
      'priority_support',   // ì¶”ê°€!
    ],
    createdAt: now,
    updatedAt: now,
  );
}
```

---

## ğŸ’ VIP ê²½í—˜ (íšŒì› ë¡œê·¸ì¸ ì‹œ)

### ë¡œê·¸ì¸ ì‹œ ìë™ ì²˜ë¦¬

```dart
// lib/services/auth_service.dart

Future<void> _onLoginSuccess() async {
  try {
    debugPrint('ğŸ‰ ë¡œê·¸ì¸ ì„±ê³µ - VIP ê²½í—˜ ì‹œì‘');

    // 1. ì›°ì»´ ë©”ì‹œì§€
    _showWelcomeMessage();

    // 2. êµ¬ë… ìƒíƒœ ìë™ ë³µì›
    await _restoreSubscription();

    // 3. í´ë¼ìš°ë“œ ë™ê¸°í™” ìë™ ì‹œì‘
    await _autoSync();

    // 4. ëŒ€ê¸° ì¤‘ì¸ êµ¬ë§¤ ì²˜ë¦¬
    await _completePendingPurchases();

    // 5. í”„ë¦¬ë¡œë“œ (ë¹ ë¥¸ ë¡œë”©)
    await _preloadUserData();

    debugPrint('âœ… VIP ê²½í—˜ ì¤€ë¹„ ì™„ë£Œ');

  } catch (e) {
    debugPrint('âš ï¸ VIP ê²½í—˜ ì¤€ë¹„ ì˜¤ë¥˜: $e');
  }
}

// ì›°ì»´ ë©”ì‹œì§€
void _showWelcomeMessage() {
  final user = _currentUser;
  if (user == null) return;

  final subscription = _currentSubscription;

  String message;
  if (subscription?.type == SubscriptionType.lifetime) {
    message = 'ğŸ’ ${user.displayName}ë‹˜, í‰ìƒ ë©¤ë²„ë¡œ ëŒì•„ì˜¤ì…¨ë„¤ìš”!';
  } else if (subscription?.type == SubscriptionType.yearly) {
    message = 'ğŸ–ï¸ ${user.displayName}ë‹˜, ì—°ê°„ ë©¤ë²„ë¡œ ëŒì•„ì˜¤ì…¨ë„¤ìš”!';
  } else if (subscription?.type == SubscriptionType.monthly) {
    message = 'â­ ${user.displayName}ë‹˜, í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ë¡œ ëŒì•„ì˜¤ì…¨ë„¤ìš”!';
  } else {
    message = 'ğŸ‘‹ ${user.displayName}ë‹˜, ë‹¤ì‹œ ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤!';
  }

  // UIì— í‘œì‹œ (SnackBar or Toast)
  _welcomeMessage = message;
  notifyListeners();
}

// êµ¬ë… ìƒíƒœ ë³µì›
Future<void> _restoreSubscription() async {
  debugPrint('ğŸ”„ êµ¬ë… ìƒíƒœ ìë™ ë³µì› ì¤‘...');

  final cloudSync = CloudSyncService();
  final subscription = await cloudSync.loadSubscription(_currentUser!.uid);

  if (subscription != null && subscription.isValid) {
    _currentSubscription = subscription;
    debugPrint('âœ… êµ¬ë… ë³µì›: ${subscription.type}');
  }
}

// í´ë¼ìš°ë“œ ë™ê¸°í™”
Future<void> _autoSync() async {
  debugPrint('â˜ï¸ í´ë¼ìš°ë“œ ìë™ ë™ê¸°í™” ì¤‘...');

  final cloudSync = CloudSyncService();
  await cloudSync.syncUserData();

  debugPrint('âœ… í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ');
}

// ì‚¬ìš©ì ë°ì´í„° í”„ë¦¬ë¡œë“œ (ë¹ ë¥¸ ë¡œë”©)
Future<void> _preloadUserData() async {
  debugPrint('âš¡ ì‚¬ìš©ì ë°ì´í„° í”„ë¦¬ë¡œë”©...');

  // ìš´ë™ ê¸°ë¡, ì§„í–‰ ìƒí™©, ì—…ì  ë“± ë¯¸ë¦¬ ë¡œë“œ
  final cloudSync = CloudSyncService();
  await Future.wait([
    cloudSync.preloadWorkoutHistory(_currentUser!.uid),
    cloudSync.preloadProgress(_currentUser!.uid),
    cloudSync.preloadAchievements(_currentUser!.uid),
  ]);

  debugPrint('âœ… í”„ë¦¬ë¡œë“œ ì™„ë£Œ - ë¹ ë¥¸ UI ë¡œë”© ì¤€ë¹„');
}
```

---

## ğŸ” êµ¬ë§¤ ê²€ì¦ ë¡œì§

### í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê¸°ë³¸ ê²€ì¦

```dart
// lib/services/purchase_verification_service.dart

class PurchaseVerificationService {

  /// ê¸°ë³¸ ê²€ì¦ (í´ë¼ì´ì–¸íŠ¸)
  bool verifyPurchaseLocally(PurchaseDetails purchase) {
    // 1. ìƒí’ˆ ID í™•ì¸
    if (!_isValidProductId(purchase.productID)) {
      debugPrint('âŒ ì˜ëª»ëœ ìƒí’ˆ ID: ${purchase.productID}');
      return false;
    }

    // 2. êµ¬ë§¤ ìƒíƒœ í™•ì¸
    if (purchase.status != PurchaseStatus.purchased) {
      debugPrint('âŒ êµ¬ë§¤ ë¯¸ì™„ë£Œ: ${purchase.status}');
      return false;
    }

    // 3. íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸ (24ì‹œê°„ ì´ë‚´)
    final purchaseTime = DateTime.parse(purchase.transactionDate ?? '');
    final now = DateTime.now();
    final difference = now.difference(purchaseTime);

    if (difference.inHours > 24) {
      debugPrint('âš ï¸ 24ì‹œê°„ ì´ìƒ ê²½ê³¼í•œ êµ¬ë§¤: ${difference.inHours}ì‹œê°„');
      // í—ˆìš©ì€ í•˜ë˜ ë¡œê·¸ ê¸°ë¡
    }

    debugPrint('âœ… í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ í†µê³¼');
    return true;
  }

  bool _isValidProductId(String productId) {
    return [
      'premium_monthly',
      'premium_yearly',
      'premium_lifetime',
    ].contains(productId);
  }

  /// ì„œë²„ ê²€ì¦ (ë°°í¬ ì‹œ êµ¬í˜„)
  Future<bool> verifyPurchaseWithServer(
    String productId,
    String purchaseToken,
  ) async {
    try {
      debugPrint('ğŸ” ì„œë²„ ê²€ì¦ ì‹œì‘...');

      // TODO: Firebase Functions í˜¸ì¶œ
      // final functions = FirebaseFunctions.instance;
      // final result = await functions
      //     .httpsCallable('verifyAndroidPurchase')
      //     .call({
      //   'productId': productId,
      //   'purchaseToken': purchaseToken,
      // });

      // if (result.data['verified'] == true) {
      //   debugPrint('âœ… ì„œë²„ ê²€ì¦ ì„±ê³µ');
      //   return true;
      // }

      // ì„ì‹œ: í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ë§Œ ì‚¬ìš©
      debugPrint('âš ï¸ ì„œë²„ ê²€ì¦ ë¯¸êµ¬í˜„ - í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ë§Œ ì‚¬ìš©');
      return true;

    } catch (e) {
      debugPrint('âŒ ì„œë²„ ê²€ì¦ ì˜¤ë¥˜: $e');
      return false;
    }
  }
}
```

### billing_service.dartì— ê²€ì¦ ì¶”ê°€

```dart
// lib/services/billing_service.dart

Future<void> _handlePurchase(PurchaseDetails purchaseDetails) async {
  try {
    // 1. í´ë¼ì´ì–¸íŠ¸ ê²€ì¦
    final verificationService = PurchaseVerificationService();
    final isValid = verificationService.verifyPurchaseLocally(purchaseDetails);

    if (!isValid) {
      debugPrint('âŒ êµ¬ë§¤ ê²€ì¦ ì‹¤íŒ¨');
      _onPurchaseError?.call('êµ¬ë§¤ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      return;
    }

    // 2. êµ¬ë… í™œì„±í™”
    await _activateSubscription(purchaseDetails.productID);

    // 3. (ì„ íƒ) ì„œë²„ ê²€ì¦
    // await verificationService.verifyPurchaseWithServer(
    //   purchaseDetails.productID,
    //   purchaseDetails.verificationData.serverVerificationData,
    // );

    debugPrint('âœ… êµ¬ë§¤ ì²˜ë¦¬ ì™„ë£Œ');

  } catch (e) {
    debugPrint('âŒ êµ¬ë§¤ ì²˜ë¦¬ ì˜¤ë¥˜: $e');
    _onPurchaseError?.call('êµ¬ë§¤ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
  }
}
```

---

## ğŸ“Š ìµœì¢… ê¶Œì¥ ì‚¬í•­

### êµ¬ë§¤ ëª¨ë¸: **í•˜ì´ë¸Œë¦¬ë“œ** â­

```
1. ì›”ê°„ êµ¬ë…:  â‚©4,900/ì›”   (ë¶€ë‹´ ì—†ìŒ)
2. ì—°ê°„ êµ¬ë…:  â‚©49,000/ë…„  (17% í• ì¸)
3. í‰ìƒ êµ¬ë§¤:  â‚©99,000     (í‰ìƒ ì†Œìœ , ì¶”ì²œ!)
```

### ì´ìœ :
1. **ìµœëŒ€ ì „í™˜ìœ¨** - ê°€ê²©ëŒ€ë³„ ì„ íƒ
2. **ì•ˆì •ì  ìˆ˜ìµ** - êµ¬ë… + 1íšŒì„±
3. **ì‚¬ìš©ì ë§Œì¡±** - ì„ íƒê¶Œ ì œê³µ

---

## ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1: ê¸°ë³¸ êµ¬ì¡° (í˜„ì¬)
- [x] UserSubscription ëª¨ë¸ í™•ì¥
- [x] billing_service êµ¬ì¡°

### Phase 2: ìƒí’ˆ ì¶”ê°€ (ë‹¤ìŒ ì‘ì—…)
- [ ] í‰ìƒ êµ¬ë§¤ ìƒí’ˆ ì¶”ê°€
- [ ] VIP ê²½í—˜ êµ¬í˜„
- [ ] êµ¬ë§¤ ê²€ì¦ ì¶”ê°€

### Phase 3: ì„œë²„ ê²€ì¦ (ë°°í¬ ì „)
- [ ] Firebase Functions êµ¬í˜„
- [ ] Google Play API ì—°ë™

---

**ì‘ì„±ì:** Claude
**ì‘ì„±ì¼:** 2025-10-28
**ê²°ì •:** í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ (ì›”ê°„/ì—°ê°„/í‰ìƒ)
